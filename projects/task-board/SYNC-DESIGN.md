# 任务同步设计方案

## 需求

1. **HOC 对话添加任务**：用户与 HOC 对话时，HOC 可以自动添加任务到看板
2. **任务看板 UI 添加任务**：用户在看板界面手动添加任务
3. **双向同步**：两种方式添加的任务都能看到

---

## 方案设计

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      双向同步架构                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌─────────────┐                      ┌─────────────┐      │
│   │  HOC 对话   │                      │ 任务看板 UI │      │
│   └──────┬──────┘                      └──────┬──────┘      │
│          │                                    │             │
│          │ 写入                               │ 读写         │
│          ▼                                    ▼             │
│   ┌─────────────────────────────────────────────────┐      │
│   │              memory/tasks.json                  │      │
│   │              (共享数据源)                        │      │
│   └─────────────────────────────────────────────────┘      │
│                          │                                  │
│                          ▼                                  │
│   ┌─────────────────────────────────────────────────┐      │
│   │              /api/tasks (Next.js API)           │      │
│   └─────────────────────────────────────────────────┘      │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 同步机制

| 场景 | 触发方式 | 同步方向 |
|------|----------|----------|
| HOC 添加任务 | HOC 直接编辑 tasks.json | → 文件 → 看板轮询刷新 |
| 看板添加任务 | UI 表单提交 | → API → 文件 |
| 看板修改任务 | UI 表单提交 | → API → 文件 |
| HOC 修改任务 | HOC 直接编辑 tasks.json | → 文件 → 看板轮询刷新 |

### 技术实现

#### 1. HOC 添加任务（直接编辑文件）

```typescript
// HOC 调用 write 工具编辑 memory/tasks.json
// 添加新任务到 tasks 数组

const newTask = {
  id: `task-${Date.now()}`,
  title: "新任务标题",
  description: "任务描述",
  status: "待办",
  assignee: "HOC",
  priority: "高",
  project: "项目名称",
  createdAt: Date.now(),
  updatedAt: Date.now()
};
```

#### 2. 任务看板同步（轮询 + 手动刷新）

```typescript
// 每 30 秒自动刷新
useEffect(() => {
  const interval = setInterval(() => {
    loadTasksFromAPI();
  }, 30000);
  return () => clearInterval(interval);
}, []);

// 手动刷新按钮
const handleRefresh = async () => {
  const tasks = await loadTasksFromAPI();
  setTasks(tasks);
};
```

#### 3. 任务数据格式

```json
{
  "tasks": [
    {
      "id": "task-001",
      "title": "任务标题",
      "description": "任务描述",
      "status": "待办 | 进行中 | 已完成 | 已取消",
      "assignee": "HOC | 主人",
      "priority": "低 | 中 | 高 | 紧急",
      "taskType": "普通 | 计划任务 | Cron任务",
      "project": "项目名称",
      "tags": ["标签1", "标签2"],
      "dueDate": "2026-02-22",
      "createdAt": 1740058200000,
      "updatedAt": 1740058200000,
      "completedAt": null
    }
  ],
  "metadata": {
    "lastUpdated": 1740058200000,
    "version": 1
  }
}
```

---

## 用户体验

### HOC 添加任务流程

```
用户: "帮我添加一个任务：完成 HomeBox Android 开发"
      ↓
HOC: "好的，已添加任务到看板"
      ↓
HOC: 直接编辑 memory/tasks.json
      ↓
用户在任务看板看到新任务（自动刷新或点击刷新）
```

### 看板添加任务流程

```
用户: 打开任务看板
      ↓
用户: 点击"新建任务"按钮
      ↓
用户: 填写表单，点击"创建"
      ↓
看板: 通过 API 保存到 memory/tasks.json
      ↓
任务显示在看板上
```

---

## 实现清单

- [x] `memory/tasks.json` - 共享数据文件
- [x] `/api/tasks` - API 端点
- [ ] 任务看板 - 添加自动刷新（30秒轮询）
- [ ] 任务看板 - 添加手动刷新按钮
- [ ] 任务看板 - 添加项目筛选
- [ ] HOC - 添加任务时编辑 tasks.json
